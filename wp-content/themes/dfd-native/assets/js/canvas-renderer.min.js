THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){function t(){Rt.setRGB(0,0,0),vt.setRGB(0,0,0),St.setRGB(0,0,0);for(var e=0,t=w.length;t>e;e++){var i=w[e],n=i.color;i instanceof THREE.AmbientLight?Rt.add(n):i instanceof THREE.DirectionalLight?vt.add(n):i instanceof THREE.PointLight&&St.add(n)}}function i(e,t,i){for(var n=0,o=w.length;o>n;n++){var r=w[n];if(dt.copy(r.color),r instanceof THREE.DirectionalLight){var a=Tt.setFromMatrixPosition(r.matrixWorld).normalize(),s=t.dot(a);if(0>=s)continue;s*=r.intensity,i.add(dt.multiplyScalar(s))}else if(r instanceof THREE.PointLight){var a=Tt.setFromMatrixPosition(r.matrixWorld),s=t.dot(Tt.subVectors(a,e).normalize());if(0>=s)continue;if(s*=0==r.distance?1:1-Math.min(e.distanceTo(a)/r.distance,1),0==s)continue;s*=r.intensity,i.add(dt.multiplyScalar(s))}}}function n(e,t,i){h(i.opacity),d(i.blending);var n=t.scale.x*K,o=t.scale.y*Q,r=.5*Math.sqrt(n*n+o*o);if(ut.min.set(e.x-r,e.y-r),ut.max.set(e.x+r,e.y+r),i instanceof THREE.SpriteMaterial){var a=i.map;if(null!==a&&void 0!==a.image){a.hasEventListener("update",c)===!1&&(a.image.width>0&&p(a),a.addEventListener("update",c));var s=mt[a.id];R(void 0!==s?s:"rgba( 0, 0, 0, 1 )");var l=a.image,E=l.width*a.offset.x,f=l.height*a.offset.y,m=l.width*a.repeat.x,x=l.height*a.repeat.y,y=n/m,v=o/x;et.save(),et.translate(e.x,e.y),0!==i.rotation&&et.rotate(i.rotation),et.translate(-n/2,-o/2),et.scale(y,v),et.translate(-E,-f),et.fillRect(E,f,m,x),et.restore()}else R(i.color.getStyle()),et.save(),et.translate(e.x,e.y),0!==i.rotation&&et.rotate(i.rotation),et.scale(n,-o),et.fillRect(-.5,-.5,1,1),et.restore()}else i instanceof THREE.SpriteCanvasMaterial&&(u(i.color.getStyle()),R(i.color.getStyle()),et.save(),et.translate(e.x,e.y),0!==i.rotation&&et.rotate(i.rotation),et.scale(n,o),i.program(et),et.restore())}function o(e,t,i,n){if(h(n.opacity),d(n.blending),et.beginPath(),et.moveTo(e.positionScreen.x,e.positionScreen.y),et.lineTo(t.positionScreen.x,t.positionScreen.y),n instanceof THREE.LineBasicMaterial){if(m(n.linewidth),x(n.linecap),y(n.linejoin),n.vertexColors!==THREE.VertexColors)u(n.color.getStyle());else{var o=i.vertexColors[0].getStyle(),r=i.vertexColors[1].getStyle();if(o===r)u(o);else{try{var a=et.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,o),a.addColorStop(1,r)}catch(s){a=o}u(a)}}et.stroke(),ut.expandByScalar(2*n.linewidth)}else n instanceof THREE.LineDashedMaterial&&(m(n.linewidth),x(n.linecap),y(n.linejoin),u(n.color.getStyle()),v([n.dashSize,n.gapSize]),et.stroke(),ut.expandByScalar(2*n.linewidth),v([]))}function r(e,t,n,o,r,c,p,f){if(I.info.render.vertices+=3,I.info.render.faces++,h(f.opacity),d(f.blending),b=e.positionScreen.x,B=e.positionScreen.y,P=t.positionScreen.x,z=t.positionScreen.y,V=n.positionScreen.x,j=n.positionScreen.y,a(b,B,P,z,V,j),(f instanceof THREE.MeshLambertMaterial||f instanceof THREE.MeshPhongMaterial)&&null===f.map)ft.copy(f.color),ht.copy(f.emissive),f.vertexColors===THREE.FaceColors&&ft.multiply(p.color),Et.copy(Rt),gt.copy(e.positionWorld).add(t.positionWorld).add(n.positionWorld).divideScalar(3),i(gt,p.normalModel,Et),Et.multiply(ft).add(ht),f.wireframe===!0?s(Et,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):l(Et);else if(f instanceof THREE.MeshBasicMaterial||f instanceof THREE.MeshLambertMaterial||f instanceof THREE.MeshPhongMaterial)if(null!==f.map){var m=f.map.mapping;m===THREE.UVMapping&&(D=p.uvs,E(b,B,P,z,V,j,D[o].x,D[o].y,D[r].x,D[r].y,D[c].x,D[c].y,f.map))}else null!==f.envMap?f.envMap.mapping===THREE.SphericalReflectionMapping&&(wt.copy(p.vertexNormalsModel[o]).applyMatrix3(Ht),W=.5*wt.x+.5,F=.5*wt.y+.5,wt.copy(p.vertexNormalsModel[r]).applyMatrix3(Ht),N=.5*wt.x+.5,k=.5*wt.y+.5,wt.copy(p.vertexNormalsModel[c]).applyMatrix3(Ht),O=.5*wt.x+.5,G=.5*wt.y+.5,E(b,B,P,z,V,j,W,F,N,k,O,G,f.envMap)):(Et.copy(f.color),f.vertexColors===THREE.FaceColors&&Et.multiply(p.color),f.wireframe===!0?s(Et,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):l(Et));else f instanceof THREE.MeshDepthMaterial?(Et.r=Et.g=Et.b=1-S(e.positionScreen.z*e.positionScreen.w,H.near,H.far),f.wireframe===!0?s(Et,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):l(Et)):f instanceof THREE.MeshNormalMaterial?(wt.copy(p.normalModel).applyMatrix3(Ht),Et.setRGB(wt.x,wt.y,wt.z).multiplyScalar(.5).addScalar(.5),f.wireframe===!0?s(Et,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):l(Et)):(Et.setRGB(1,1,1),f.wireframe===!0?s(Et,f.wireframeLinewidth,f.wireframeLinecap,f.wireframeLinejoin):l(Et))}function a(e,t,i,n,o,r){et.beginPath(),et.moveTo(e,t),et.lineTo(i,n),et.lineTo(o,r),et.closePath()}function s(e,t,i,n){m(t),x(i),y(n),u(e.getStyle()),et.stroke(),ut.expandByScalar(2*t)}function l(e){R(e.getStyle()),et.fill()}function c(e){p(e.target)}function p(e){if(!(e instanceof THREE.CompressedTexture)){var t=e.wrapS===THREE.RepeatWrapping,i=e.wrapT===THREE.RepeatWrapping,n=e.image,o=document.createElement("canvas");o.width=n.width,o.height=n.height;var r=o.getContext("2d");r.setTransform(1,0,0,-1,0,n.height),r.drawImage(n,0,0),mt[e.id]=et.createPattern(o,t===!0&&i===!0?"repeat":t===!0&&i===!1?"repeat-x":t===!1&&i===!0?"repeat-y":"no-repeat")}}function E(e,t,i,n,o,r,a,s,l,E,f,h,d){if(!(d instanceof THREE.DataTexture)){d.hasEventListener("update",c)===!1&&(void 0!==d.image&&d.image.width>0&&p(d),d.addEventListener("update",c));var m=mt[d.id];if(void 0===m)return R("rgba(0,0,0,1)"),void et.fill();R(m);var x,y,u,v,S,T,g,w,H=d.offset.x/d.repeat.x,C=d.offset.y/d.repeat.y,M=d.image.width*d.repeat.x,L=d.image.height*d.repeat.y;a=(a+H)*M,s=(s+C)*L,l=(l+H)*M,E=(E+C)*L,f=(f+H)*M,h=(h+C)*L,i-=e,n-=t,o-=e,r-=t,l-=a,E-=s,f-=a,h-=s,g=l*h-f*E,0!==g&&(w=1/g,x=(h*i-E*o)*w,y=(h*n-E*r)*w,u=(l*o-f*i)*w,v=(l*r-f*n)*w,S=e-x*a-u*s,T=t-y*a-v*s,et.save(),et.transform(x,y,u,v,S,T),et.fill(),et.restore())}}function f(e,t,i){var n,o=t.x-e.x,r=t.y-e.y,a=o*o+r*r;0!==a&&(n=i/Math.sqrt(a),o*=n,r*=n,t.x+=o,t.y+=r,e.x-=o,e.y-=r)}function h(e){nt!==e&&(et.globalAlpha=e,nt=e)}function d(e){ot!==e&&(e===THREE.NormalBlending?et.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?et.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending&&(et.globalCompositeOperation="darker"),ot=e)}function m(e){st!==e&&(et.lineWidth=e,st=e)}function x(e){lt!==e&&(et.lineCap=e,lt=e)}function y(e){ct!==e&&(et.lineJoin=e,ct=e)}function u(e){rt!==e&&(et.strokeStyle=e,rt=e)}function R(e){at!==e&&(et.fillStyle=e,at=e)}function v(e){pt.length!==e.length&&(et.setLineDash(e),pt=e)};var S=THREE.Math.smoothstep;e=e||{};var T,g,w,H,C,M,L,b,B,P,z,V,j,D,W,F,N,k,O,G,I=this,A=new THREE.Projector,q=void 0!==e.canvas?e.canvas:document.createElement("canvas"),U=q.width,J=q.height,K=Math.floor(U/2),Q=Math.floor(J/2),X=0,Y=0,Z=U,$=J,_=1,et=q.getContext("2d",{alpha:e.alpha===!0}),tt=new THREE.Color(0),it=e.alpha===!0?0:1,nt=1,ot=0,rt=null,at=null,st=null,lt=null,ct=null,pt=[],Et=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),ft=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),ht=new THREE.Color,dt=new THREE.Color,mt={},xt=new THREE.Box2,yt=new THREE.Box2,ut=new THREE.Box2,Rt=new THREE.Color,vt=new THREE.Color,St=new THREE.Color,Tt=new THREE.Vector3,gt=new THREE.Vector3,wt=new THREE.Vector3,Ht=new THREE.Matrix3;void 0===et.setLineDash&&(et.setLineDash=function(){}),this.domElement=q,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getPixelRatio=function(){return _},this.setPixelRatio=function(e){_=e},this.setSize=function(e,t,i){U=e*_,J=t*_,q.width=U,q.height=J,K=Math.floor(U/2),Q=Math.floor(J/2),i!==!1&&(q.style.width=e+"px",q.style.height=t+"px"),xt.min.set(-K,-Q),xt.max.set(K,Q),yt.min.set(-K,-Q),yt.max.set(K,Q),nt=1,ot=0,rt=null,at=null,st=null,lt=null,ct=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,n){X=e*_,Y=t*_,Z=i*_,$=n*_},this.setScissor=function(){},this.enableScissorTest=function(){},this.setClearColor=function(e,t){tt.set(e),it=void 0!==t?t:1,yt.min.set(-K,-Q),yt.max.set(K,Q)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return tt},this.getClearAlpha=function(){return it},this.getMaxAnisotropy=function(){return 0},this.clear=function(){yt.empty()===!1&&(yt.intersect(xt),yt.expandByScalar(2),yt.min.x=yt.min.x+K,yt.min.y=-yt.min.y+Q,yt.max.x=yt.max.x+K,yt.max.y=-yt.max.y+Q,1>it&&et.clearRect(0|yt.min.x,0|yt.max.y,yt.max.x-yt.min.x|0,yt.min.y-yt.max.y|0),it>0&&(d(THREE.NormalBlending),h(1),R("rgba("+Math.floor(255*tt.r)+","+Math.floor(255*tt.g)+","+Math.floor(255*tt.b)+","+it+")"),et.fillRect(0|yt.min.x,0|yt.max.y,yt.max.x-yt.min.x|0,yt.min.y-yt.max.y|0)),yt.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,i){if(i instanceof THREE.Camera==!1)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");this.autoClear===!0&&this.clear(),I.info.render.vertices=0,I.info.render.faces=0,et.setTransform(Z/U,0,0,-$/J,X,J-Y),et.translate(K,Q),T=A.projectScene(e,i,this.sortObjects,this.sortElements),g=T.elements,w=T.lights,H=i,Ht.getNormalMatrix(i.matrixWorldInverse),t();for(var a=0,s=g.length;s>a;a++){var l=g[a],c=l.material;if(void 0!==c&&0!==c.opacity){if(ut.makeEmpty(),l instanceof THREE.RenderableSprite)C=l,C.x*=K,C.y*=Q,n(C,l,c);else if(l instanceof THREE.RenderableLine)C=l.v1,M=l.v2,C.positionScreen.x*=K,C.positionScreen.y*=Q,M.positionScreen.x*=K,M.positionScreen.y*=Q,ut.setFromPoints([C.positionScreen,M.positionScreen]),xt.isIntersectionBox(ut)===!0&&o(C,M,l,c);else if(l instanceof THREE.RenderableFace){if(C=l.v1,M=l.v2,L=l.v3,C.positionScreen.z<-1||C.positionScreen.z>1)continue;if(M.positionScreen.z<-1||M.positionScreen.z>1)continue;if(L.positionScreen.z<-1||L.positionScreen.z>1)continue;C.positionScreen.x*=K,C.positionScreen.y*=Q,M.positionScreen.x*=K,M.positionScreen.y*=Q,L.positionScreen.x*=K,L.positionScreen.y*=Q,c.overdraw>0&&(f(C.positionScreen,M.positionScreen,c.overdraw),f(M.positionScreen,L.positionScreen,c.overdraw),f(L.positionScreen,C.positionScreen,c.overdraw)),ut.setFromPoints([C.positionScreen,M.positionScreen,L.positionScreen]),xt.isIntersectionBox(ut)===!0&&r(C,M,L,0,1,2,l,c)}yt.union(ut)}}et.setTransform(1,0,0,1,0,0)}};